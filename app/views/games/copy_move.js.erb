var game_id = '<%= @game_id %>'
var view = '<%= @view %>';
var msg = '<%= @message %>';
var form_type;

if (msg) {
    UIkit.notification({
        message: $('<div/>').html(msg).text(),
        pos: 'top-right',
        timeout: 5000
    });
}

<% if @errors.empty? %>

    var wi_same_coll = <%= @wi_same_coll %>;
    var copy = <%= @copy %>;

    if (view != 'list') {
        UIkit.dropdown("#copy-form-" + game_id).hide();
    }

    if (wi_same_coll || !copy) {

        var data = {
            type: 'refresh',
            view: view
        };

        if ($('#r-q').text().length != 0 && $('#r-s').text().length != 0) {
            search = $('#r-q').text().split(',');
            data['q'] = {
                name_dev_cont: search[0],
                plat_eq: search[1],
                physical_eq: search[2],
                s: $('#r-s').text()
            };
        } else if ($('#r-q').text().length != 0) {
            search = $('#r-q').text().split(',');
            data['q'] = {
                name_dev_cont: search[0],
                plat_eq: search[1],
                physical_eq: search[2]
            };
        } else if ($('#r-s').text().length != 0) {
            data['q'] = {
                s: $('#r-s').text()
            };
        }

        if ($('.pr em.current').length != 0) {
            var current_page = $('.pr em.current').text();

            if (!copy) {

                switch (view) {
                    case 'covers':
                        var selector = '.game-space';
                        break;
                    case 'panels':
                        var selector = '.g-panel';
                        break;
                    case 'list':
                        var selector = '.t-game';
                        break;
                }
                var num_of_games = $(selector).length;
                if (num_of_games == 1) {
                    current_page -= 1;
                }

            }

            data['page'] = current_page;
        }

        var scroll = $(document).scrollTop().valueOf();

        <% if @collection.needs_platform %>
            var new_platform = '<%= @new_platform %>';
            updatePlatformsFilter(new_platform);
        <% end %>

        $.ajax({
            url: '/collections/<%= @current.id %>',
            data: data,
            complete: function(data) {
                $(document).scrollTop(scroll);
            }
        });

    } else {

        if (view === 'list') {
            UIkit.modal("#t-ops").hide();
        }
    }

<% else %>

    if (view === 'list') {
        var errors = $("#t-ops .add-form-errors");
        form_type = 'list';
    } else {
        var errors = $("#copy-form-" + game_id + " .add-form-errors");
        form_type = 'copy';
    }

    errors.html("<%= j(render partial: 'add_form_errors', locals: { errors: @errors }) %>");
    resetFormErrors(form_type, game_id);
<% end %>
