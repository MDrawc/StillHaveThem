var game_id = '<%= @game_id %>';
var view = '<%= @view %>';
var msg = '<%= @message %>';
var reopen = false;
var form_type;

if (msg) {
    UIkit.notification({
        message: $('<div/>').html(msg).text(),
        pos: 'top-right',
        timeout: 5000
    });
}

<% if @errors.empty? %>

    var new_game_id = '<%= @new_game_id %>';

    if (view === 'panels') {
        reopen = $('#g-drop-' + game_id).attr('style') == 'display: block;';
    }

    var data = { type: 'refresh', view: view };

    var $rq = $('#r-q');
    var rs = $rq.next().text();
    var rq = $rq.text();
    if ( rq != ',,on' && rq != ',,') {
        var search = rq.split(',');
        data['q'] = {
            name_dev_cont: search[0],
            plat_eq: search[1],
            physical_eq: search[2],
        };
    }

    if (rs.length) {
        if (data['q']) {
            data['q']['s'] = rs;
        } else {
            data['q'] = {
                s: rs
            };
        }
    }

    var $pagi = $('#pr').find('em.current');

    if ($pagi.length) {
        var current_page = $pagi.text();
        data['page'] = current_page;
    }

    var scroll = $(document).scrollTop().valueOf();

    var new_platform = '<%= @new_platform %>';
    updatePlatformsFilter(new_platform);

    $.ajax({
        url: '/collections/<%= @collection.id %>',
        data: data,
        complete: function(data) {

            $(document).scrollTop(scroll);

            if (reopen) {
                $('#g-drop-' + new_game_id).show();
            }
        }
    });

<% else %>

    if (view === 'list') {
        var $errors = $("#t-ops").find(".add-form-errors");
        form_type = 'list';
    } else {
        var $errors = $("#edit-form-" + game_id).find(".add-form-errors");
        form_type = 'edit';
    }

    $errors.html("<%= j(render partial: 'add_form_errors', locals: { errors: @errors }) %>");
    resetFormErrors(form_type, game_id);

<% end %>
